<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DCA Statement System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body{
      margin:0;
      font-family:Segoe UI,Arial;
      background:#020617;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#e5e7eb;
    }

    .container{
      width:100%;
      max-width:760px;
      background:#020617;
      border-radius:18px;
      padding:28px;
      box-shadow:0 0 60px rgba(0,0,0,.7);
      border:1px solid #1e293b;
    }

    /* ===== FORM ===== */
    #formBox{}
    h2{text-align:center;margin-top:0;font-weight:600;}

    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }

    label{font-size:11px;color:#94a3b8;}

    input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #334155;
      background:#020617;
      color:#e5e7eb;
    }

    input:focus{
      outline:none;
      border-color:#38bdf8;
      box-shadow:0 0 0 2px rgba(56,189,248,.25);
    }

    .full{grid-column:1/-1;}

    button{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:none;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#022c22;
      font-weight:700;
      margin-top:18px;
      cursor:pointer;
      transition:.3s;
    }

    button:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 25px rgba(34,197,94,.35);
    }

    /* ===== SUMMARY ===== */
    #summaryBox{display:none;}

    .summary-card{
      background:#020617;
      border:1px solid #1e293b;
      border-radius:16px;
      padding:26px;
      text-align:center;
      animation:fadeIn .4s ease;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .success{color:#22c55e;}
    .invalid{color:#ef4444;}

    .ref{
      margin-top:8px;
      font-size:12px;
      color:#94a3b8;
    }

    .download-btn{
      margin-top:16px;
      background:linear-gradient(135deg,#2563eb,#38bdf8);
      color:#020617;
    }

    .footer{
      text-align:center;
      font-size:10px;
      color:#64748b;
      margin-top:16px;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- ===== FORM ===== -->
    <div id="formBox">
      <h2>DCA Statement Generator</h2>

      <div class="form-grid">
        <div class="full">
          <label>Security Key</label>
          <input id="key" type="password">
        </div>

        <div>
          <label>Customer Name</label>
          <input id="customer_name">
        </div>

        <div>
          <label>IC Number</label>
          <input id="ic">
        </div>

        <div>
          <label>Account No</label>
          <input id="account_no">
        </div>

        <div>
          <label>Product</label>
          <input id="product">
        </div>

        <div>
          <label>Agreement Date</label>
          <input id="agreement_date" type="date">
        </div>

        <div>
          <label>Due Date</label>
          <input id="due_date" type="date">
        </div>

        <div>
          <label>Outstanding</label>
          <input id="outstanding">
        </div>

        <div>
          <label>Payable</label>
          <input id="payable">
        </div>

        <div>
          <label>Valid Until</label>
          <input id="valid_until" type="date">
        </div>

        <div>
          <label>Reference (Client)</label>
          <input id="ref_client">
        </div>

        <div class="full">
          <label>Letter Date</label>
          <input id="letter_date" type="date">
        </div>
      </div>

      <button onclick="generate()">Generate Statement</button>
    </div>

    <!-- ===== SUMMARY ===== -->
    <div id="summaryBox">
      <div class="summary-card">

        <!-- SUCCESS -->
        <div id="successBox" style="display:none;">
          <h2 class="success">Statement Generated</h2>
          <div class="ref">
            Reference No: <span id="refSuccess"></span>
          </div>
          <button class="download-btn" onclick="downloadPdf()">Download PDF</button>
        </div>

        <!-- INVALID -->
        <div id="invalidBox" style="display:none;">
          <h2 class="invalid">Invalid Security Key</h2>
          <p>Access denied. Unauthorized generation attempt.</p>
          <div class="ref">
            Reference No: <span id="refInvalid"></span>
          </div>
        </div>

      </div>
    </div>

    <div class="footer">
      Secure DCA Statement System · Audit Mode · 2026
    </div>

  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwKaTU30-Vjvh2ubFnPorBijeyTZoddXy0uRHKOqz96_xeAuQABFQd7q9Hpz_cVvTbH/exec";
    let CURRENT_REF = "";

    function generate(){
      const fields = [
        "key","customer_name","ic","account_no","product",
        "agreement_date","due_date","outstanding","payable",
        "valid_until","ref_client","letter_date"
      ];

      const fd = new FormData();

      for(const f of fields){
        const el = document.getElementById(f);
        if(!el.value.trim()){
          alert("All fields required");
          return;
        }
        fd.append(f, el.value.trim());
      }

      fetch(API_URL,{method:"POST",body:fd})
        .then(r=>r.json())
        .then(j=>{
          document.getElementById("formBox").style.display="none";
          document.getElementById("summaryBox").style.display="block";

          if(j.status==="success"){
            CURRENT_REF = j.ref;
            document.getElementById("successBox").style.display="block";
            document.getElementById("invalidBox").style.display="none";
            document.getElementById("refSuccess").innerText = j.ref;
          }else{
            document.getElementById("successBox").style.display="none";
            document.getElementById("invalidBox").style.display="block";
            document.getElementById("refInvalid").innerText = j.ref || "-";
          }
        })
        .catch(()=>{
          alert("System error. Please try again.");
        });
    }

function downloadPdf(){
  if(!CURRENT_REF) return;
  const url = `${API_URL}?action=download&ref=${encodeURIComponent(CURRENT_REF)}`;
  window.open(url, "_blank");   // direct browser navigation
}

  fetch(url)
    .then(res=>{
      if(!res.ok) throw new Error("HTTP ERROR");
      const type = res.headers.get("content-type") || "";
      if(!type.includes("pdf")){
        return res.text().then(t=>{ throw new Error(t); });
      }
      return res.blob();
    })
    .then(blob=>{
      if(blob.size < 1000){
        throw new Error("INVALID_PDF_BINARY");
      }

      const fileURL = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = fileURL;
      a.download = `STATEMENT_${CURRENT_REF}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(fileURL);
    })
    .catch(err=>{
      alert("Download failed: " + err.message);
    });
}

  </script>
</body>
</html>
